import { Component, OnInit } from '@angular/core';
import { CommonModule } from '@angular/common';
import { FormsModule } from '@angular/forms';
import { ProductService, Product } from './services/product.service';
import { Observable } from 'rxjs';

@Component({
  selector: 'app-root',
  standalone: true,
  imports: [CommonModule, FormsModule],
  template: `
    <div style="max-width: 600px; margin: auto; padding: 20px; text-align: center;">
      <h1>ğŸ› Ù…Ø¹Ø±Ø¶ Ø§Ù„Ù…Ù†ØªØ¬Ø§Øª</h1>

      <!-- Ù†Ù…ÙˆØ°Ø¬ Ø¥Ø¯Ø®Ø§Ù„/ØªØ¹Ø¯ÙŠÙ„ Ù…Ù†ØªØ¬ -->
      <div style="margin-bottom: 30px; border: 1px solid #ccc; padding: 20px; border-radius: 8px;">
        <h3>{{ editMode ? 'ØªØ¹Ø¯ÙŠÙ„ Ø§Ù„Ù…Ù†ØªØ¬' : 'Ø¥Ø¶Ø§ÙØ© Ù…Ù†ØªØ¬ Ø¬Ø¯ÙŠØ¯' }}</h3>
        <input type="file" (change)="onImageSelect($event)" accept="image/*"><br><br>
        <input type="text" placeholder="Ø§Ø³Ù… Ø§Ù„Ù…Ù†ØªØ¬" [(ngModel)]="newProduct.name"><br><br>
        <input type="text" placeholder="Ø§Ù„ÙˆØµÙ" [(ngModel)]="newProduct.description"><br><br>
        <input type="number" placeholder="Ø§Ù„Ø³Ø¹Ø±" [(ngModel)]="newProduct.price"><br><br>
        <button *ngIf="!editMode" (click)="addProduct()">â• Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ù…Ù†ØªØ¬</button>
        <button *ngIf="editMode" (click)="updateProduct()">ğŸ’¾ Ø­ÙØ¸ Ø§Ù„ØªØ¹Ø¯ÙŠÙ„Ø§Øª</button>
        <button *ngIf="editMode" (click)="cancelEdit()" style="margin-left: 10px; background-color: #ccc; color: black; border: none; padding: 8px 12px; border-radius: 4px;">
          âŒ Ø¥Ù„ØºØ§Ø¡
        </button>
      </div>

      <!-- Ø¹Ø±Ø¶ Ø§Ù„Ù…Ù†ØªØ¬Ø§Øª -->
      <div *ngFor="let product of products$ | async; let i = index" style="margin-bottom: 40px; border-bottom: 1px dashed #aaa; padding-bottom: 20px;">
        <div (click)="openProductDetails(product)" style="cursor: pointer;">
          <img [src]="product.image" alt="ØµÙˆØ±Ø© Ø§Ù„Ù…Ù†ØªØ¬" style="width: 200px; border-radius: 8px;">
          <h3>{{ product.name }}</h3>
        </div>
        <p>{{ product.description }}</p>
        <p>ğŸ’µ Ø§Ù„Ø³Ø¹Ø±: {{ product.price }} Ù„.Ø³</p>
        <button (click)="editProduct(i)" style="background-color: #4CAF50; color: white; border: none; padding: 8px 12px; border-radius: 4px; margin-right: 10px;">
          âœï¸ ØªØ¹Ø¯ÙŠÙ„
        </button>
        <button (click)="deleteProduct(i)" style="background-color: #f44336; color: white; border: none; padding: 8px 12px; border-radius: 4px;">
          ğŸ—‘ Ø­Ø°Ù
        </button>
      </div>
    </div>
  `,
})
export class AppComponent implements OnInit {
  products$: Observable<Product[]>;
  newProduct: Product = {
    name: '',
    description: '',
    price: null,
    image: '',
  };
  editMode: boolean = false;
  editIndex: number | null = null;

  constructor(private productService: ProductService) {
    this.products$ = this.productService.products$;
  }

  ngOnInit() {}

  onImageSelect(event: Event) {
    const input = event.target as HTMLInputElement;
    if (input.files && input.files[0]) {
      const reader = new FileReader();
      reader.onload = () => {
        this.newProduct.image = reader.result as string;
      };
      reader.readAsDataURL(input.files[0]);
    }
  }

  addProduct() {
    const { name, description, price, image } = this.newProduct;
    if (name && description && price && image) {
      this.productService.addProduct({ ...this.newProduct });
      this.resetForm();
    } else {
      alert('âš ï¸ Ø§Ù„Ø±Ø¬Ø§Ø¡ Ø¥Ø¯Ø®Ø§Ù„ Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ù‚Ø¨Ù„ Ø§Ù„Ø¥Ø¶Ø§ÙØ©.');
    }
  }

  editProduct(index: number) {
    const products = this.productService.getProducts();
    this.newProduct = { ...products[index] };
    this.editMode = true;
    this.editIndex = index;
  }

  updateProduct() {
    const { name, description, price, image } = this.newProduct;
    if (name && description && price && image && this.editIndex !== null) {
      this.productService.updateProduct(this.editIndex, { ...this.newProduct });
      this.resetForm();
    } else {
      alert('âš ï¸ Ø§Ù„Ø±Ø¬Ø§Ø¡ Ø¥Ø¯Ø®Ø§Ù„ Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ù‚Ø¨Ù„ Ø§Ù„Ø­ÙØ¸.');
    }
  }

  cancelEdit() {
    this.resetForm();
  }

  deleteProduct(index: number) {
    this.productService.deleteProduct(index);
  }
  openProductDetails(product: Product) {
      const html = `
        <html>
          <head>
            <title>${product.name}</title>
            <style>
              body { font-family: Arial; text-align: center; padding: 20px; }
              img { width: 300px; border-radius: 8px; margin-bottom: 20px; }
            </style>
          </head>
          <body>
            <h1>${product.name}</h1>
            <img src="${product.image}" alt="ØµÙˆØ±Ø© Ø§Ù„Ù…Ù†ØªØ¬">
            <p>${product.description}</p>
            <p><strong>Ø§Ù„Ø³Ø¹Ø±:</strong> ${product.price} Ù„.Ø³</p>
          </body>
        </html>
      `;
      const detailWindow = window.open('', '_blank');
      detailWindow!.document.write(html);
      detailWindow!.document.close();
    }

    private resetForm() {
      this.newProduct = {
        name: '',
        description: '',
        price: null,
        image: '',
      };
      this.editMode = false;
      this.editIndex = null;
    }
  }